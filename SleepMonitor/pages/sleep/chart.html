<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>睡眠数据图表</title>
<script src="https://cdn.jsdelivr.net/npm/vue@3"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts@5"></script>
<style>
  html, body, #app {
    margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden;
    background: transparent;
  }
  #chart {
    width: 100%; height: 100%;
    -webkit-tap-highlight-color: transparent;
    user-select: none; -webkit-user-select: none;
    touch-action: pan-x pan-y;
  }
</style>
</head>
<body>
<div id="app">
  <sleep-chart :is-dark="isDark" :chart-data="chartData" />
</div>

<script>
const { createApp, ref, watch, onMounted } = Vue;

const SleepChart = {
  props: {
    isDark: Boolean,
    chartData: Object
  },
  template: `<div id="chart"></div>`,
  data() {
    return {
      chart: null,
      defaultOption: {
        grid: { top: 40, right: 20, bottom: 40, left: 50, containLabel: true },
        dataZoom: [{
          type: 'inside', start: 0, end: 33.33,
          zoomOnMouseWheel: false,
          moveOnMouseMove: true,
          moveOnMouseWheel: false,
          preventDefaultMouseMove: true,
          throttle: 0,
          rangeMode: ['value', 'value'],
          filterMode: 'filter',
          zoomLock: true,
          minSpan: 33.33,
          maxSpan: 33.33
        }],
        tooltip: {
          trigger: 'axis',
          axisPointer: { type: 'line', lineStyle: { color: 'rgba(0,0,0,0.1)', width: 1 } },
          backgroundColor: 'rgba(255,255,255,0.9)',
          borderColor: 'rgba(0,0,0,0.1)',
          borderWidth: 1,
          textStyle: { color: '#666', fontSize: 12 },
          padding: [8, 12],
          formatter: (params) => {
            const val = params[0].value;
            const name = params[0].seriesName;
            const unit = name === '心率' ? '次/分' :
                         name === '呼吸频率' ? '次/分' :
                         name === '体温' ? '°C' : 'dB';
            return `${params[0].axisValue}<br/>${name}: ${val}${unit}`;
          }
        },
        xAxis: {
          type: 'category',
          boundaryGap: true,
          data: [],
          axisLine: { lineStyle: { color: 'rgba(0,0,0,0.08)', width: 1 } },
          axisLabel: {
            color: '#999', fontSize: 12, rotate: 0,
            formatter: val => val.split(':')[0] + '时'
          },
          axisTick: { lineStyle: { color: 'rgba(0,0,0,0.08)', width: 1 } },
          splitLine: { lineStyle: { color: 'rgba(0,0,0,0.03)', type: 'dashed', width: 1 } }
        },
        yAxis: {
          type: 'value',
          axisLine: { lineStyle: { color: 'rgba(0,0,0,0.08)', width: 1 } },
          axisLabel: { color: '#999', fontSize: 12, margin: 8, formatter: v => v.toFixed(1) },
          axisTick: { lineStyle: { color: 'rgba(0,0,0,0.08)', width: 1 } },
          splitLine: { lineStyle: { color: 'rgba(0,0,0,0.03)', type: 'dashed', width: 1 } }
        },
        series: [{
          type: 'line',
          smooth: true,
          symbol: 'circle',
          symbolSize: 6,
          showSymbol: false,
          data: [],
          areaStyle: { opacity: 0.15 },
          lineStyle: { width: 2, shadowColor: 'rgba(0,0,0,0.1)', shadowBlur: 4 },
          emphasis: { focus: 'series', itemStyle: { borderWidth: 2 } },
          animation: false,
          zlevel: 1,
          z: 1
        }]
      }
    };
  },
  methods: {
    initChart() {
      this.chart = echarts.init(this.$el, null, {
        renderer: 'canvas',
        devicePixelRatio: window.devicePixelRatio || 1
      });
      this.chart.setOption(this.defaultOption);
    },
    updateTheme(isDark) {
      const textColor = isDark ? '#fff' : '#333';
      const gridColor = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.08)';
      const splitLineColor = isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.03)';

      this.chart.setOption({
        backgroundColor: isDark ? '#2c2c2c' : '#ffffff',
        tooltip: {
          backgroundColor: isDark ? 'rgba(0,0,0,0.8)' : 'rgba(255,255,255,0.9)',
          textStyle: { color: isDark ? '#fff' : '#666' }
        },
        xAxis: {
          axisLine: { lineStyle: { color: gridColor } },
          axisLabel: { color: textColor },
          axisTick: { lineStyle: { color: gridColor } },
          splitLine: { lineStyle: { color: splitLineColor } }
        },
        yAxis: {
          axisLine: { lineStyle: { color: gridColor } },
          axisLabel: { color: textColor },
          axisTick: { lineStyle: { color: gridColor } },
          splitLine: { lineStyle: { color: splitLineColor } }
        }
      });
    },
    updateData(data) {
      if (!data || !data.times || !data.values) return;
      const color = data.color || 'rgb(66,133,244)';
      this.chart.setOption({
        xAxis: { data: data.times },
        series: [{
          name: data.name || '指标',
          data: data.values,
          itemStyle: {
            color: color,
            borderColor: '#fff',
            borderWidth: 1
          },
          areaStyle: {
            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
              { offset: 0, color: color.replace(')', ', 0.2)').replace('rgb', 'rgba') },
              { offset: 1, color: color.replace(')', ', 0.05)').replace('rgb', 'rgba') }
            ])
          }
        }]
      });
    }
  },
  mounted() {
    this.initChart();
    this.updateTheme(this.isDark);
    this.updateData(this.chartData);
    window.addEventListener('resize', () => this.chart.resize());
  },
  watch: {
    isDark(newVal) {
      this.updateTheme(newVal);
    },
    chartData(newData) {
      this.updateData(newData);
    }
  }
};

createApp({
  components: { SleepChart },
  setup() {
    const isDark = ref(false);
    const chartData = ref({
      times: [],
      values: [],
      name: '',
      color: ''
    });

    // 接收外部消息
    window.addEventListener('message', e => {
      console.log('图表组件收到消息:', e.data);
      const { type, data } = e.data || {};
      if (type === 'themeChange') {
        console.log('更新主题:', data.isDark);
        isDark.value = data.isDark;
      } else if (type === 'dataUpdate') {
        console.log('更新数据:', {
          times: data.times?.length,
          values: data.values?.length,
          name: data.name
        });
        chartData.value = data;
      } else if (type === 'ping') {
        // 响应父页面的ping消息
        console.log('收到ping消息，发送pong响应');
        window.parent.postMessage({
          type: 'pong',
          data: { id: window.location.hash.slice(1) }
        }, '*');
      }
    });

    // 等待DOM加载完成后发送ready消息
    onMounted(() => {
      console.log('图表组件已挂载，准备发送ready消息');
      // 延迟发送ready消息，确保父页面已准备好
      setTimeout(() => {
        try {
          const id = window.location.hash.slice(1);
          console.log('发送webviewReady消息:', id);
          window.parent.postMessage({
            type: 'webviewReady',
            data: { id }
          }, '*');
        } catch (error) {
          console.error('发送ready消息失败:', error);
        }
      }, 500);
    });

    return { isDark, chartData };
  }
}).mount('#app');
</script>
</body>
</html>
